#include <common.h>
#include <exports.h>
#include <generated/autoconf.h>

#define U32REG(r) *((volatile uint32_t *)r)
#define GPIO1_DATA 0x30200000
#define GPIO1_DIR 0x30200004
#define GPIO5_DATA 0x30240000
#define GPIO5_DIR 0x30240004
#define GPIO3_DATA 0x30220000
#define GPIO3_DIR 0x30220004
#define RESET_LINE 0x00080000
#define ECSPI2_SPI_BASE 0x30830000
#define ECSPI2_TX_FIFO (ECSPI2_SPI_BASE + 0x04)
#define ECSPI2_STATREG (ECSPI2_SPI_BASE + 0x18)
#define ECSPI2_CONREG (ECSPI2_SPI_BASE + 0x08)
#define ECSPI2_CONFIGREG (ECSPI2_SPI_BASE + 0x0C)
#define STATREG_TXCOMPLETE_MASK 0x80
#define CONREG_TRIGGER_TX 0x00000004
#define BURST_MASK 0xFFF00000
#define BURST_VAL(b) ((uint32_t)(b - 1)<<20)
#define CMD_BYTES(b) b
#define DATA_BYTES(b) (0x80 | b)
#define EOSTREAM 0

#ifdef CONFIG_TARGET_FLEX7_MIDI
   #define DC_DATA GPIO3_DATA
   #define DC_DIR GPIO3_DIR
   #define DC_LINE 0x2000000
#elif defined CONFIG_TARGET_FLEX7_MIDI_MK1    /* legacy for first prototype boards */
   #define DC_DATA GPIO1_DATA
   #define DC_DIR GPIO1_DIR
   #define DC_LINE 0x20
#else
   #define DC_DATA GPIO5_DATA
   #define DC_DIR GPIO5_DIR
   #define DC_LINE 0x00001000
#endif


//forward declarations
void InitSPI(void);
void PrintAt(char *pString,const uint8_t *font, int x, int y, int intensity);

int splash (int argc, char * const argv[])
{
   InitSPI();
   return 0;
}


const uint8_t initData[]=
{ 
   CMD_BYTES(2),0xfd,0x12,
   CMD_BYTES(1),0xae,
   CMD_BYTES(2),0x81,0xff,
   CMD_BYTES(2),0xa0,0x53,
   CMD_BYTES(2),0xa2,0x5c,
   CMD_BYTES(1),0xa4,26,
   CMD_BYTES(2),0xa8,0x63,
   CMD_BYTES(2),0xab,0x00,
   CMD_BYTES(2),0xb1,0x22,
   CMD_BYTES(2),0xb3,0xF0,
   CMD_BYTES(2),0xb6,0x0F,
   CMD_BYTES(2),0xbe,0x07,
   CMD_BYTES(2),0xD5,0x62,
   CMD_BYTES(1),0xAF,

   EOSTREAM
};

uint8_t *SPISend(uint8_t *pData, int bytesToGo, int isData)
{
   int burstLen=0;
   uint32_t txData;
   uint32_t reg;
   if (bytesToGo>0)
   {
      int partial;
      U32REG(ECSPI2_STATREG) = STATREG_TXCOMPLETE_MASK;
      burstLen= (8 * bytesToGo) /*+ 1 */;
      reg=U32REG(ECSPI2_CONREG);
      reg &= ~BURST_MASK;
      reg |= BURST_VAL(burstLen);
      U32REG(ECSPI2_CONREG) = reg;        
      /* deal with partial U32 first*/
      partial=burstLen & 0x1F;
      txData=0;
   //   txData= isData ? 1:0;
      if (isData)
      {
         U32REG(DC_DATA) |= DC_LINE;
      }
      else
      {
         U32REG(DC_DATA) &= ~DC_LINE;
      }
     if (partial>1)
      {
         while (partial >1)
         {
            partial -=8;
            txData<<=8;
            txData |= pData[0];
            pData++;
            bytesToGo--;
         }
         U32REG(ECSPI2_TX_FIFO)=txData;

      }
      while (bytesToGo>0)
      {
            txData=((uint32_t)pData[0] << 24) | ((uint32_t)pData[1] << 16) | ((uint32_t)pData[2] << 8) | pData[3];
            pData+=4;
            bytesToGo-=4;
            U32REG(ECSPI2_TX_FIFO)=txData;
      }
      U32REG(ECSPI2_CONREG) = reg | CONREG_TRIGGER_TX;       
      while ( !(U32REG(ECSPI2_STATREG) & STATREG_TXCOMPLETE_MASK) )  // todo - add timeout
         ;
   }
   return pData;
 
}

uint8_t * SPISendStream(uint8_t * pData)
{
   while (*pData)
   {
      pData=SPISend(pData+1, pData[0] & 0x7f, pData[0] & 0x80 ? 1:0);
   }
   return pData;
}

/*
  font and logo_gry image data are generated by code in the 
  Flex7/Platform/Linux/SoC/iMX8/Drivers/SPIDisplayDriver/FontSource directory
*/

const uint8_t font10x6[]=
{
   0x20,0x7F,10,6,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00, 
0x12, 0x12, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x0A, 0x0A, 0x1F, 0x0A, 0x0A, 0x0A, 0x1F, 0x0A, 0x0A, 0x00, 
0x04, 0x04, 0x1E, 0x05, 0x0E, 0x14, 0x0F, 0x04, 0x04, 0x00, 
0x17, 0x15, 0x0B, 0x08, 0x04, 0x02, 0x1A, 0x15, 0x1D, 0x00, 
0x02, 0x05, 0x05, 0x02, 0x03, 0x15, 0x09, 0x09, 0x16, 0x00, 
0x0C, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x08, 0x04, 0x04, 0x02, 0x02, 0x02, 0x04, 0x04, 0x08, 0x00, 
0x02, 0x04, 0x04, 0x08, 0x08, 0x08, 0x04, 0x04, 0x02, 0x00, 
0x00, 0x04, 0x15, 0x0E, 0x04, 0x0E, 0x15, 0x04, 0x00, 0x00, 
0x00, 0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x06, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00, 
0x10, 0x10, 0x08, 0x08, 0x04, 0x02, 0x02, 0x01, 0x01, 0x00, 
0x0E, 0x11, 0x19, 0x19, 0x15, 0x13, 0x13, 0x11, 0x0E, 0x00, 
0x04, 0x06, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00, 
0x0E, 0x11, 0x10, 0x10, 0x08, 0x04, 0x02, 0x01, 0x1F, 0x00, 
0x0E, 0x11, 0x10, 0x10, 0x0C, 0x10, 0x10, 0x11, 0x0E, 0x00, 
0x0C, 0x0A, 0x0A, 0x09, 0x09, 0x1F, 0x08, 0x08, 0x08, 0x00, 
0x1E, 0x02, 0x01, 0x01, 0x0F, 0x10, 0x10, 0x11, 0x0E, 0x00, 
0x0E, 0x11, 0x01, 0x0D, 0x13, 0x11, 0x11, 0x11, 0x0E, 0x00, 
0x1F, 0x10, 0x10, 0x08, 0x08, 0x04, 0x04, 0x04, 0x04, 0x00, 
0x0E, 0x11, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x11, 0x0E, 0x00, 
0x0E, 0x11, 0x11, 0x11, 0x19, 0x16, 0x10, 0x11, 0x0E, 0x00, 
0x00, 0x0C, 0x0C, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00, 0x00, 
0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x08, 0x04, 0x00, 
0x00, 0x10, 0x08, 0x04, 0x02, 0x04, 0x08, 0x10, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 
0x00, 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00, 
0x0E, 0x11, 0x11, 0x10, 0x08, 0x04, 0x04, 0x00, 0x04, 0x00, 
0x00, 0x0E, 0x11, 0x19, 0x15, 0x15, 0x1D, 0x01, 0x0E, 0x00, 
0x04, 0x0A, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11, 0x11, 0x00, 
0x0F, 0x11, 0x11, 0x11, 0x0F, 0x11, 0x11, 0x11, 0x0F, 0x00, 
0x0E, 0x11, 0x01, 0x01, 0x01, 0x01, 0x01, 0x11, 0x0E, 0x00, 
0x07, 0x09, 0x11, 0x11, 0x11, 0x11, 0x11, 0x09, 0x07, 0x00, 
0x1F, 0x01, 0x01, 0x01, 0x0F, 0x01, 0x01, 0x01, 0x1F, 0x00, 
0x1F, 0x01, 0x01, 0x01, 0x0F, 0x01, 0x01, 0x01, 0x01, 0x00, 
0x0E, 0x11, 0x01, 0x01, 0x19, 0x11, 0x11, 0x11, 0x0E, 0x00, 
0x11, 0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11, 0x11, 0x00, 
0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00, 
0x1C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x0E, 0x00, 
0x11, 0x11, 0x09, 0x05, 0x03, 0x05, 0x09, 0x11, 0x11, 0x00, 
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x1F, 0x00, 
0x11, 0x11, 0x1B, 0x1F, 0x15, 0x11, 0x11, 0x11, 0x11, 0x00, 
0x13, 0x13, 0x15, 0x15, 0x19, 0x19, 0x11, 0x11, 0x11, 0x00, 
0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00, 
0x0F, 0x11, 0x11, 0x11, 0x0F, 0x01, 0x01, 0x01, 0x01, 0x00, 
0x0E, 0x11, 0x11, 0x11, 0x15, 0x15, 0x09, 0x09, 0x16, 0x00, 
0x0F, 0x11, 0x11, 0x11, 0x0F, 0x09, 0x11, 0x11, 0x11, 0x00, 
0x0E, 0x11, 0x01, 0x01, 0x0E, 0x10, 0x10, 0x11, 0x0E, 0x00, 
0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 
0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00, 
0x11, 0x11, 0x11, 0x0A, 0x0A, 0x0A, 0x04, 0x04, 0x04, 0x00, 
0x11, 0x11, 0x11, 0x15, 0x15, 0x1B, 0x1B, 0x11, 0x11, 0x00, 
0x11, 0x11, 0x0A, 0x0A, 0x04, 0x0A, 0x0A, 0x11, 0x11, 0x00, 
0x11, 0x11, 0x0A, 0x0A, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 
0x1F, 0x10, 0x08, 0x08, 0x04, 0x02, 0x02, 0x01, 0x1F, 0x00, 
0x0E, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0E, 0x00, 
0x01, 0x01, 0x02, 0x02, 0x04, 0x08, 0x08, 0x10, 0x10, 0x00, 
0x0E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00, 
0x04, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x00, 
0x0C, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x0E, 0x10, 0x1E, 0x11, 0x19, 0x16, 0x00, 
0x01, 0x01, 0x01, 0x0D, 0x13, 0x11, 0x11, 0x11, 0x0F, 0x00, 
0x00, 0x00, 0x00, 0x0E, 0x11, 0x01, 0x01, 0x11, 0x0E, 0x00, 
0x10, 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x11, 0x1E, 0x00, 
0x00, 0x00, 0x00, 0x0E, 0x11, 0x1F, 0x01, 0x01, 0x1E, 0x00, 
0x0C, 0x02, 0x02, 0x02, 0x0F, 0x02, 0x02, 0x02, 0x02, 0x00, 
0x00, 0x00, 0x00, 0x1E, 0x11, 0x11, 0x1E, 0x10, 0x0E, 0x00, 
0x01, 0x01, 0x01, 0x0F, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 
0x00, 0x00, 0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 
0x00, 0x00, 0x10, 0x00, 0x10, 0x10, 0x11, 0x11, 0x0E, 0x00, 
0x01, 0x01, 0x11, 0x11, 0x09, 0x07, 0x09, 0x11, 0x11, 0x00, 
0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08, 0x00, 
0x00, 0x00, 0x00, 0x0A, 0x15, 0x15, 0x11, 0x11, 0x11, 0x00, 
0x00, 0x00, 0x00, 0x0D, 0x13, 0x11, 0x11, 0x11, 0x11, 0x00, 
0x00, 0x00, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00, 
0x00, 0x00, 0x00, 0x0F, 0x11, 0x11, 0x0F, 0x01, 0x01, 0x00, 
0x00, 0x00, 0x00, 0x1E, 0x11, 0x11, 0x1E, 0x30, 0x10, 0x00, 
0x00, 0x00, 0x00, 0x0D, 0x13, 0x01, 0x01, 0x01, 0x01, 0x00, 
0x00, 0x00, 0x00, 0x1E, 0x01, 0x0E, 0x10, 0x11, 0x0E, 0x00, 
0x02, 0x02, 0x02, 0x0F, 0x02, 0x02, 0x02, 0x12, 0x0C, 0x00, 
0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x19, 0x16, 0x00, 
0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x0A, 0x0A, 0x04, 0x00, 
0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x15, 0x15, 0x0A, 0x00, 
0x00, 0x00, 0x00, 0x11, 0x0A, 0x04, 0x04, 0x0A, 0x11, 0x00, 
0x00, 0x00, 0x00, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x0E, 0x00, 
0x00, 0x00, 0x00, 0x1F, 0x08, 0x04, 0x02, 0x01, 0x1F, 0x00, 
0x08, 0x04, 0x04, 0x04, 0x02, 0x04, 0x04, 0x04, 0x08, 0x00, 
0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x00, 
0x04, 0x08, 0x08, 0x08, 0x10, 0x08, 0x08, 0x08, 0x04, 0x00, 
0x00, 0x00, 0x00, 0x02, 0x15, 0x08, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};

const uint8_t logo_gry[] = {
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x21, 0x44, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x52, 0x76, 0x47, 0x75, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x51, 0x77, 0x77, 0x77, 0x77, 0x77, 0x67, 0x15, 0x11, 0x41, 0x77,
  0x77, 0x47, 0x11, 0x11, 0x41, 0x76, 0x77, 0x77, 0x77, 0x57, 0x12, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x63, 0x77, 0x77, 0x47, 0x76, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x71, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x12, 0x61, 0x77,
  0x77, 0x37, 0x11, 0x31, 0x76, 0x77, 0x77, 0x77, 0x77, 0x77, 0x47, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x51, 0x77, 0x77, 0x77, 0x47, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x71, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x16, 0x61, 0x77,
  0x77, 0x17, 0x11, 0x74, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x14,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x76, 0x77, 0x77, 0x77, 0x47, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x67, 0x71, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x17, 0x71, 0x77,
  0x77, 0x17, 0x41, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x27,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x72,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x71, 0x77, 0x77, 0x16, 0x11,
  0x11, 0x71, 0x77, 0x77, 0x16, 0x11, 0x75, 0x77, 0x77, 0x17, 0x71, 0x77,
  0x77, 0x17, 0x71, 0x77, 0x77, 0x77, 0x13, 0x11, 0x75, 0x77, 0x77, 0x57,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x21, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x74, 0x77, 0x77, 0x15, 0x11,
  0x11, 0x74, 0x77, 0x77, 0x15, 0x11, 0x61, 0x77, 0x77, 0x17, 0x71, 0x77,
  0x77, 0x16, 0x75, 0x77, 0x77, 0x27, 0x11, 0x11, 0x51, 0x77, 0x77, 0x67,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x71, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x74, 0x77, 0x77, 0x14, 0x11,
  0x11, 0x74, 0x77, 0x77, 0x14, 0x11, 0x72, 0x77, 0x77, 0x16, 0x72, 0x77,
  0x77, 0x16, 0x77, 0x77, 0x77, 0x14, 0x11, 0x11, 0x21, 0x77, 0x77, 0x77,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x76, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x76, 0x77, 0x77, 0x14, 0x11,
  0x11, 0x76, 0x77, 0x77, 0x45, 0x54, 0x77, 0x77, 0x77, 0x14, 0x74, 0x77,
  0x77, 0x25, 0x77, 0x77, 0x77, 0x11, 0x11, 0x11, 0x11, 0x77, 0x77, 0x77,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x51, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x76, 0x77, 0x77, 0x11, 0x11,
  0x11, 0x76, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x57, 0x11, 0x75, 0x77,
  0x77, 0x44, 0x77, 0x77, 0x67, 0x11, 0x11, 0x11, 0x11, 0x77, 0x77, 0x77,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x74, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x77, 0x77, 0x77, 0x11, 0x11,
  0x11, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x67, 0x12, 0x11, 0x76, 0x77,
  0x77, 0x63, 0x77, 0x77, 0x57, 0x11, 0x11, 0x11, 0x11, 0x77, 0x77, 0x77,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x31, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x77, 0x77, 0x77, 0x11, 0x11,
  0x11, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x12, 0x11, 0x76, 0x77,
  0x77, 0x61, 0x77, 0x77, 0x47, 0x11, 0x11, 0x11, 0x31, 0x77, 0x77, 0x67,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x71, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x77, 0x77, 0x67, 0x11, 0x11,
  0x11, 0x77, 0x77, 0x77, 0x66, 0x77, 0x77, 0x77, 0x15, 0x11, 0x77, 0x77,
  0x77, 0x61, 0x77, 0x77, 0x47, 0x11, 0x11, 0x11, 0x51, 0x77, 0x77, 0x57,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x76, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x77, 0x77, 0x67, 0x11, 0x11,
  0x11, 0x77, 0x77, 0x67, 0x11, 0x74, 0x77, 0x77, 0x16, 0x11, 0x77, 0x77,
  0x77, 0x61, 0x77, 0x77, 0x67, 0x11, 0x11, 0x11, 0x71, 0x77, 0x77, 0x37,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x51, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x41, 0x77, 0x77, 0x57, 0x11, 0x11,
  0x41, 0x77, 0x77, 0x57, 0x11, 0x71, 0x77, 0x77, 0x17, 0x11, 0x77, 0x77,
  0x67, 0x41, 0x77, 0x77, 0x77, 0x12, 0x11, 0x11, 0x76, 0x77, 0x77, 0x16,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x75, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x41, 0x77, 0x77, 0x47, 0x11, 0x11,
  0x41, 0x77, 0x77, 0x47, 0x11, 0x51, 0x77, 0x77, 0x47, 0x11, 0x77, 0x77,
  0x67, 0x11, 0x77, 0x77, 0x77, 0x37, 0x11, 0x63, 0x77, 0x77, 0x77, 0x13,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x51, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x61, 0x77, 0x77, 0x47, 0x11, 0x11,
  0x61, 0x77, 0x77, 0x47, 0x11, 0x41, 0x77, 0x77, 0x67, 0x41, 0x77, 0x77,
  0x57, 0x11, 0x76, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x57, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x75, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x61, 0x77, 0x77, 0x17, 0x11, 0x11,
  0x61, 0x77, 0x77, 0x17, 0x11, 0x11, 0x77, 0x77, 0x77, 0x41, 0x77, 0x77,
  0x47, 0x11, 0x61, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x15, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x62, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x71, 0x77, 0x77, 0x17, 0x11, 0x11,
  0x71, 0x77, 0x77, 0x17, 0x11, 0x11, 0x77, 0x77, 0x77, 0x62, 0x77, 0x77,
  0x47, 0x11, 0x11, 0x76, 0x77, 0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x51, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x61, 0x77, 0x77, 0x16, 0x11, 0x11,
  0x61, 0x77, 0x77, 0x16, 0x11, 0x11, 0x75, 0x77, 0x77, 0x54, 0x77, 0x77,
  0x17, 0x11, 0x11, 0x31, 0x76, 0x77, 0x77, 0x77, 0x46, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x52, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77, 0x77,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x47, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x24, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
  0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11

};

void PrintAt(char *pString,const uint8_t *font, int x, int y, int intensity)
{
   int fontw=font[3];
   int fonth=font[2];
   int xx,yy;
   uint8_t stream[20];

   while ((pString[0] >=font[0]) && (pString[0]<=font[1]))
   {
      uint8_t *pData= &font[4+ (fonth * (pString[0]-font[0]))];
      stream[0]=0x15;
      stream[1]=8+(x/2);
      stream[2]=8+((x + fontw) /2 ) - 1;
      SPISend(&stream[0],3,0);
      stream[0]=0x75;
      stream[1]=y;
      stream[2]=y + fonth -1;
      SPISend(&stream[0],3,0);
      for (yy=0; yy < fonth; yy++)
      {
         int idx=0;
         for (xx=fontw;xx>0;xx-=2)
         {
      //      stream[idx++]=(yy+6) * 0x11;
            stream[idx]= (pData[yy] & (1<<(fontw-xx))) ? 0xF0 : 0;
            stream[idx++] |= (pData[yy] & (1<<(fontw-xx-1))) ? 0x0F : 0 ;
         }
         SPISend(&stream[0],fontw/2,1);
      }
      x+=fontw;
      pString++;
   }
}

#define DELAY_APPROX_1ms 170200

void delayms(int dly)
{
   volatile uint32_t outer;
   volatile uint32_t inner;

   for (outer=0; outer < dly; outer++)
   {
      for (inner=0; inner<DELAY_APPROX_1ms; inner++)
      {
         ;
      }
   }
}

/* Pinctrl established in U-Boot dts
   
   mw.l 30830008 1
   mw.l 3083000C 1100FF
   mw.l 30830008 5F031F1
*/
void InitSPI(void)
{
   volatile int loop; 
   volatile int outer;
   uint8_t * pData=(uint8_t *)&initData[0];
   uint8_t data[8];

   U32REG(DC_DIR) |=  DC_LINE ; /* make line output */
   U32REG(ECSPI2_CONREG) = 0; /*disable */
   delayms(1);
   U32REG(ECSPI2_CONREG) = 1; /*enable */
   delayms(1);
   U32REG(ECSPI2_CONFIGREG) = 0x1100FF;
   U32REG(ECSPI2_CONREG) = 0x5F031F1;
   delayms(1);
   while (*pData)
   {
      pData=SPISendStream(pData);
   }
   /* CLEAR DISPLAY */
   data[0]=0x15;
   data[1]=8;   /* 0 + 8 */
   data[2]=55;  /* (96/2) + 8 -1  inclusive*/
   SPISend(&data[0],3,0);
   data[0]=0x75;
   data[1]=0;
   data[2]=63;
   SPISend(&data[0],3,0);
   data[0]=data[1]=data[2]=data[3]=data[4]=data[5]=data[6]=data[7]=0;
   for (loop=0; loop<384;loop++)
   {
      SPISend(&data[0],8,1);
   }
   /* ADD TRIO LOGO */
   data[0]=0x15;
   data[1]=8;
   data[2]=55;
   SPISend(&data[0],3,0);
   data[0]=0x75;
   data[1]=15;
   data[2]=48;
   SPISend(&data[0],3,0);
   pData=(uint8_t *)&logo_gry[0];
   for (loop=0;loop<34;loop++)
   {
      SPISend(&pData[0],96/2,1);
      pData += 96/2;
   }
}

/*
mw.l 303301fc 0
fatload mmc 1 ${loadaddr} splash.bin
go ${loadaddr}
mw.l 30330450 82 4

mw.l 303301fc 0
mw.l 30830008 1
mw.l 3083000C 1100FF
mw.l 30830008 5F031F1

mw.l 303301f8 5
fatload mmc 1 ${loadaddr} splash.bin
go ${loadaddr}

mw.l 303301fc 0;mw.l 30830008 1; mw.l 3083000C 1100FF; mw.l 30830008 5F031F1; mw.l 303301f8 5; fatload mmc 1 ${loadaddr} splash.bin

mw.l 30830004 96969696 ; mw.l 30830004 96969696 ; mw.l 30830004 96969696  
mw.l 30830008 5F077F5 ; md.l 30830020 1
*/

/*

memw l 30830008 0
memw l 30330450 82 82 82 82
memw l 303301f0 0 0 5 0
memw l 30330568 1 1 1 1 
memw l 30830008 1
memw l 3083000C 1100FF
memw l 30830008 5F031F1

*/

